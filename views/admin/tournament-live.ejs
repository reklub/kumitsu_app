<%- include('../partials/header') %>

<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-trophy"></i> Turniej na żywo: <%= tournament.name %></h2>
    <div>
      <a href="/admin/tournaments/<%= tournament._id %>/brackets" class="btn btn-info">
        <i class="fas fa-sitemap"></i> Zobacz drabinki
      </a>
      <a href="/admin/tournaments/<%= tournament._id %>/manage" class="btn btn-secondary">
        <i class="fas fa-cog"></i> Zarządzanie
      </a>
    </div>
  </div>

  <!-- Current Matches Section -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <i class="fas fa-play"></i> Aktualne mecze
        </div>
        <div class="card-body">
          <div id="current-matches">
            <!-- Current matches will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Brackets View -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-success text-white">
          <i class="fas fa-sitemap"></i> Drabinki turniejowe
        </div>
        <div class="card-body">
          <% if (!categories || categories.length === 0) { %>
            <p class="text-muted">Brak kategorii w turnieju</p>
          <% } else { %>
            <% categories.forEach(category => { %>
              <div class="category-bracket mb-4">
                <h5><i class="fas fa-tag"></i> <%= category.name %></h5>
                <small class="text-muted">Typ: <%= category.bracketType %> | Meczów: <%= category.matchCount %></small>
                
                <% if (category.hasMatches) { %>
                  <div class="bracket-container mt-3">
                    <div class="d-flex flex-nowrap" style="overflow-x: auto;">
                      <% category.rounds.forEach(round => { %>
                        <div class="round-column" style="flex: 0 0 auto; margin-right: 20px; min-width: 280px;">
                          <div class="round-title-live">
                            <strong><%= round.name %></strong>
                            <small class="d-block text-muted">Runda <%= round.number %></small>
                          </div>
                          
                          <% round.matches.forEach(match => { %>
                            <div class="match-live <%= match.status %>">
                              <div class="match-number-live">
                                <small><strong>#<%= match.matchNumber %></strong></small>
                              </div>
                              
                              <div class="participant-live <%= match.winner && match.participant1 && match.winner._id.toString() === match.participant1._id.toString() ? 'winner' : '' %>">
                                <% if (match.participant1) { %>
                                  <span><%= match.participant1.firstName %> <%= match.participant1.lastName %></span>
                                  <% if (match.participant1.beltRank) { %>
                                    <span class="belt-indicator-live" style="background-color: <%= match.participant1.beltRank.color %>;"></span>
                                  <% } %>
                                <% } else { %>
                                  <span class="text-muted">TBD</span>
                                <% } %>
                                <span class="score-live"><%= match.score1 || 0 %></span>
                              </div>
                              
                              <div class="participant-live <%= match.winner && match.participant2 && match.winner._id.toString() === match.participant2._id.toString() ? 'winner' : '' %>">
                                <% if (match.participant2) { %>
                                  <span><%= match.participant2.firstName %> <%= match.participant2.lastName %></span>
                                  <% if (match.participant2.beltRank) { %>
                                    <span class="belt-indicator-live" style="background-color: <%= match.participant2.beltRank.color %>;"></span>
                                  <% } %>
                                <% } else { %>
                                  <span class="text-muted">TBD</span>
                                <% } %>
                                <span class="score-live"><%= match.score2 || 0 %></span>
                              </div>
                            </div>
                          <% }) %>
                        </div>
                      <% }) %>
                    </div>
                  </div>
                <% } else { %>
                  <p class="text-muted mt-2">Brak meczów w tej kategorii. Wygeneruj drabinki.</p>
                <% } %>
              </div>
              <hr>
            <% }) %>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Matches Details Section (collapsed by default) -->
  <div class="row mt-4">
    <div class="col-12">
      <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#matchesDetail">
        <i class="fas fa-chevron-down"></i> Szczegóły meczów
      </button>
    </div>
  </div>

  <div class="collapse mt-3" id="matchesDetail">
    <div class="row">
      <% categories.forEach(category => { %>
        <div class="col-md-6 mb-4">
          <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-tag"></i> <%= category.name %></h5>
            <small class="text-muted">Typ: <%= category.bracketType %></small>
          </div>
          <div class="card-body">
            <div class="matches-container" data-category="<%= category._id %>">
              <% if (category.matches && category.matches.length > 0) { %>
                <% category.matches.forEach(match => { %>
                  <div class="match-card mb-3 p-3 border rounded" data-match="<%= match._id %>">
                    <div class="row align-items-center">
                      <div class="col-md-4">
                        <div class="participant-info">
                          <strong><%= match.participant1 ? match.participant1.firstName + ' ' + match.participant1.lastName : 'TBD' %></strong>
                          <% if (match.participant1 && match.participant1.club) { %>
                            <br><small class="text-muted"><%= match.participant1.club.clubName %></small>
                          <% } %>
                        </div>
                      </div>
                      <div class="col-md-4 text-center">
                        <div class="match-info">
                          <span class="badge badge-<%= match.status === 'completed' ? 'success' : match.status === 'in_progress' ? 'warning' : 'secondary' %>">
                            <%= match.status === 'completed' ? 'Zakończony' : match.status === 'in_progress' ? 'W trakcie' : 'Zaplanowany' %>
                          </span>
                          <% if (match.scheduledTime) { %>
                            <br><small><%= new Date(match.scheduledTime).toLocaleTimeString() %></small>
                          <% } %>
                          <% if (match.court) { %>
                            <br><small>Boisko: <%= match.court %></small>
                          <% } %>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="participant-info text-right">
                          <strong><%= match.participant2 ? match.participant2.firstName + ' ' + match.participant2.lastName : 'TBD' %></strong>
                          <% if (match.participant2 && match.participant2.club) { %>
                            <br><small class="text-muted"><%= match.participant2.club.clubName %></small>
                          <% } %>
                        </div>
                      </div>
                    </div>
                    
                    <% if (match.status === 'scheduled') { %>
                      <div class="row mt-2">
                        <div class="col-12 text-center">
                          <button class="btn btn-primary btn-sm" onclick="startMatch('<%= match._id %>')">
                            <i class="fas fa-play"></i> Rozpocznij mecz
                          </button>
                        </div>
                      </div>
                    <% } else if (match.status === 'in_progress') { %>
                      <div class="row mt-2">
                        <div class="col-12">
                          <div class="score-input">
                            <div class="row">
                              <div class="col-4">
                                <label>Wynik 1:</label>
                                <input type="number" class="form-control form-control-sm" id="score1_<%= match._id %>" value="<%= match.score1 || 0 %>">
                              </div>
                              <div class="col-4">
                                <label>Wynik 2:</label>
                                <input type="number" class="form-control form-control-sm" id="score2_<%= match._id %>" value="<%= match.score2 || 0 %>">
                              </div>
                              <div class="col-4">
                                <label>Zwycięzca:</label>
                                <select class="form-control form-control-sm" id="winner_<%= match._id %>">
                                  <option value="">Wybierz zwycięzcę</option>
                                  <% if (match.participant1) { %>
                                    <option value="<%= match.participant1._id %>"><%= match.participant1.firstName %> <%= match.participant1.lastName %></option>
                                  <% } %>
                                  <% if (match.participant2) { %>
                                    <option value="<%= match.participant2._id %>"><%= match.participant2.firstName %> <%= match.participant2.lastName %></option>
                                  <% } %>
                                </select>
                              </div>
                            </div>
                            <div class="row mt-2">
                              <div class="col-12 text-center">
                                <button class="btn btn-success btn-sm" onclick="finishMatch('<%= match._id %>')">
                                  <i class="fas fa-check"></i> Zakończ mecz
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    <% } else if (match.status === 'completed') { %>
                      <div class="row mt-2">
                        <div class="col-12 text-center">
                          <div class="result-info">
                            <strong>Wynik: <%= match.score1 %> - <%= match.score2 %></strong>
                            <% if (match.winner) { %>
                              <br><span class="text-success">Zwycięzca: <%= match.winner.firstName %> <%= match.winner.lastName %></span>
                            <% } %>
                          </div>
                        </div>
                      </div>
                    <% } %>
                  </div>
                <% }) %>
              <% } else { %>
                <p class="text-muted">Brak meczów w tej kategorii</p>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    <% }) %>
    </div>
  </div>
</div>

<style>
/* Brackets styling */
.bracket-container {
  overflow-x: auto;
  padding: 15px 0;
  background-color: #f8f9fa;
  border-radius: 5px;
  margin-top: 15px;
}

.round-column {
  display: flex;
  flex-direction: column;
}

.round-title-live {
  text-align: center;
  font-weight: bold;
  margin-bottom: 15px;
  padding: 10px;
  background-color: #e7f3ff;
  border: 2px solid #0066cc;
  border-radius: 5px;
  color: #0066cc;
}

.round-title-live small {
  font-size: 0.75em;
  font-weight: normal;
  display: block;
  margin-top: 5px;
}

.match-live {
  margin-bottom: 15px;
  padding: 8px;
  border: 2px solid #dee2e6;
  border-radius: 5px;
  background-color: white;
  min-height: 70px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.match-live.completed {
  background-color: #d4edda;
  border-color: #28a745;
}

.match-live.in_progress {
  background-color: #fff3cd;
  border-color: #ffc107;
}

.match-number-live {
  font-size: 0.85em;
  color: #666;
  margin-bottom: 5px;
  padding-bottom: 5px;
  border-bottom: 1px solid #e9ecef;
}

.participant-live {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  font-size: 0.9em;
  min-height: 25px;
}

.participant-live.winner {
  font-weight: bold;
  color: #28a745;
  background-color: rgba(40, 167, 69, 0.1);
  padding: 4px;
  border-radius: 3px;
}

.score-live {
  font-weight: bold;
  background-color: #f0f0f0;
  padding: 2px 6px;
  border-radius: 3px;
  min-width: 25px;
  text-align: center;
}

.belt-indicator-live {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 2px;
  margin-left: 5px;
  vertical-align: middle;
}

.category-bracket {
  padding: 15px;
  background-color: #ffffff;
  border: 1px solid #dee2e6;
  border-radius: 5px;
}

/* Match details styling */
.match-card {
  transition: all 0.3s ease;
}

.match-card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.participant-info {
  min-height: 50px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.score-input {
  background-color: #f8f9fa;
  padding: 15px;
  border-radius: 5px;
}

.result-info {
  background-color: #d4edda;
  padding: 10px;
  border-radius: 5px;
  border: 1px solid #c3e6cb;
}
</style>

<script>
// Start a match
function startMatch(matchId) {
  fetch(`/admin/tournaments/matches/${matchId}/start`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => {
    if (response.ok) {
      location.reload();
    } else {
      alert('Błąd podczas rozpoczynania meczu');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Błąd podczas rozpoczynania meczu');
  });
}

// Finish a match
function finishMatch(matchId) {
  const score1 = document.getElementById(`score1_${matchId}`).value;
  const score2 = document.getElementById(`score2_${matchId}`).value;
  const winner = document.getElementById(`winner_${matchId}`).value;

  if (!winner) {
    alert('Proszę wybrać zwycięzcę meczu');
    return;
  }

  fetch(`/admin/tournaments/matches/${matchId}/result`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      score1: parseInt(score1),
      score2: parseInt(score2),
      winnerId: winner
    })
  })
  .then(response => {
    if (response.ok) {
      location.reload();
    } else {
      alert('Błąd podczas zakończenia meczu');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Błąd podczas zakończenia meczu');
  });
}

// Auto-refresh every 30 seconds
setInterval(() => {
  location.reload();
}, 30000);
</script>

<%- include('../partials/footer') %>
